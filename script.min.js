"use strict";function asyncGeneratorStep(e,t,a,n,s,o,c){try{var r=e[o](c),i=r.value}catch(e){return void a(e)}r.done?t(i):Promise.resolve(i).then(n,s)}function _asyncToGenerator(r){return function(){var e=this,c=arguments;return new Promise(function(t,a){var n=r.apply(e,c);function s(e){asyncGeneratorStep(n,t,a,s,o,"next",e)}function o(e){asyncGeneratorStep(n,t,a,s,o,"throw",e)}s(void 0)})}}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var a=null!=arguments[e]?arguments[e]:{},n=Object.keys(a);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(a).filter(function(e){return Object.getOwnPropertyDescriptor(a,e).enumerable}))),n.forEach(function(e){_defineProperty(t,e,a[e])})}return t}function _defineProperty(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}var userInfo,dashboard=document.getElementById("dashboard"),editSubjectPopup=document.getElementById("edit-popup-content"),viewSubjectPopup=document.getElementById("view-popup-content"),newSubjectPopup=document.getElementById("new-popup-content"),topbar=document.getElementById("top-bar"),currentScreen=document.getElementsByClassName("screen")[0],searchCreateDiv=document.getElementById("subjects-search-create-div"),searchResultsSubject=document.getElementById("subjects-search-results"),searchResultsNone=document.getElementById("subjects-search-none"),frozenLayer=document.getElementById("frozen-layer"),frozenLayerMessage=document.getElementById("frozen-layer-message"),frozenLayerWarning=document.getElementById("frozen-layer-warning"),allPopups=["user-container","add-container","edit-container","view-container","new-container"],subjects={},removedSubject={},removedSubjectId="defaultID",toastTimer=0,toast=document.getElementById("toast"),displayName="Anónimo",photoURL="media/profile-pic.jpg",isAnonymous=!0,uid=0,db=firebase.firestore();db.settings({timestampsInSnapshots:!0});var userDB=null,subjectsDB=db.collection("subjects"),client=algoliasearch("2R59JNYNOA","b8fd696952b9984035a380a3837662e0"),index=client.initIndex("subjects_search"),subjectsToAdd={};loadData();var congratulationsVideo,cards,setPageDashboard=function(e){popupHideAll()},setPageUser=function(e){},setPageMe=function(e){popupShow("user-container",!0)},setPageMeEdit=function(e){},setPageMeSubjectEdit=function(e){subjects[e.id]?(popupShow("edit-container",!1),generateEditSubjectUI(e.id)):(showToast("You don't have the subject ".concat(e.id)),window.history.back())},setPageMeSubjectAdd=function(e){popupShow("add-container",!1),document.getElementById("search-subject-input").focus()},setPageSubjectNew=function(e){popupShow("new-container",!1),clearNewSubjectUI()},setPageSubjectView=function(t){subjectsDB.doc(t.id).get().then(function(e){e.exists?(popupShow("view-container",!1),generateViewSubjectUI(t.id,e.data())):(window.history.back(),console.error("Subject width id ".concat(t.id," doesn't exist")))}).catch(function(e){window.history.back(),console.error("Error getting subject (".concat(id,") info:"),e)})},setPageSubjectEdit=function(e){},router=new Navigo(null,!0);function showUserInfo(){router.navigate("/me")}function showAddSubject(){router.navigate("/me/subjects/add")}function showEditSubject(e){router.navigate("/me/subjects/".concat(e,"/edit"))}function showViewSubject(e){router.navigate("/subjects/".concat(e))}function showNewSubject(){router.navigate("/subjects/new")}function popupShow(e,t){popupHideAll(e);var a=document.getElementById(e);a.style.display="flex",a.animate({opacity:[0,1],easing:["ease-in"]},125).onfinish=function(){!t&&window.matchMedia("(max-width: 600px)").matches&&(currentScreen.style.display="none",topbar.style.display="none")}}function popupHide(e){currentScreen.style.display="block",topbar.style.display="flex",e.animate({opacity:[1,0],easing:["ease-in"]},125).onfinish=function(){e.style.display="none"}}function popupHideAll(e){for(var t=0,a=allPopups;t<a.length;t++){var n=a[t];n!=e&&popupHide(document.getElementById(n))}}function loadData(){for(var e in showLoader("Cargando tus asignaturas","dashboard"),subjects=getSubjectsLocalStorage(),console.info("Subjects loaded from localStorage"),subjects)autoUpdate(e),createSubjectCardCollapsed(e);hideLoader("dashboard")}function autoUpdate(e){if(null==subjects[e].evaluation&&null!=subjects[e].evaluations||(subjects[e].evaluations=toNewEvalNeeeeeeeeew(subjects[e].evaluation),delete subjects[e].evaluation,uploadEvaluation(e,subjects[e].evaluations),saveSubjectsLocalStorage()),0==Object.keys(subjects[e].evaluations).length&&(delete subjects[e],saveSubjectsLocalStorage()),null!=subjects[e].necesaryMark||null==subjects[e].necesaryMarks){for(var t in delete subjects[e].necesaryMark,subjects[e].necesaryMarks={},subjects[e].evaluations)for(var a in subjects[e].necesaryMarks[t]={},subjects[e].evaluations[t].exams)subjects[e].necesaryMarks[t][a]=subjects[e].evaluations[t].passMark;updateNecesaryMark(e),saveSubjectsLocalStorage()}}function updateSubjectCardInfo(e){getCard(e).innerHTML="<button onclick=\"deleteSubject('".concat(e,'\')" class="subject-card-remove">\n  <img src="media/trash.svg" alt="x" aria-label="Delete subject">\n</button>\n<button onclick="showEditSubject(\'').concat(e,'\')" class="subject-card-info">\n  <img src="media/edit.svg" alt="%" aria-label="Show subject information">\n</button>\n<h2>').concat(subjects[e].shortName,'</h2>\n<p class="subject-finalMark" style="color: ').concat(isPassed(e,subjects[e].selectedEvaluation)?"#5a9764":"#b9574c",';">').concat(subjects[e].finalMark[subjects[e].selectedEvaluation],'</p>\n<div class="subject-bar">').concat(generateBar(e),'</div>\n<div class="grades-input hidden" style="height: 0px;">').concat(generateInputs(e)+generateEvaluations(e),"</div>"),updateAndDisplayMarks(e,!1)}function createSubjectCardCollapsed(e){if(!document.getElementById("card-"+e)){var t=document.createElement("div");t.id="card-"+e,t.classList.add("subject-card"),t.onclick=function(e){toggleExpandCard(e,this)},t.innerHTML=" <button onclick=\"deleteSubject('".concat(e,'\')" class="subject-card-remove">\n          <img src="media/trash.svg" alt="x" aria-label="Delete subject">\n        </button>\n        <button onclick="showEditSubject(\'').concat(e,'\')" class="subject-card-info">\n          <img src="media/edit.svg" alt="%" aria-label="Show subject information">\n        </button>\n        <h2>').concat(subjects[e].shortName,'</h2>\n        <p class="subject-finalMark" style="color: ').concat(isPassed(e,subjects[e].selectedEvaluation)?"#5a9764":"#b9574c",';">').concat(subjects[e].finalMark[subjects[e].selectedEvaluation],'</p>\n        <div class="subject-bar">').concat(generateBar(e),'</div>\n        <div class="grades-input hidden" style="height: 0px;">').concat(generateInputs(e)+generateEvaluations(e),"</div>"),dashboard.appendChild(t),updateAndDisplayMarks(e,!1),hideTutorial()}}function generateBar(e){var t="";for(var a in subjects[e].evaluations[subjects[e].selectedEvaluation].exams)if(isUndone(e,a)){var n="";n=null==subjects[e].necesaryMarks[subjects[e].selectedEvaluation][a]?"ಥ_ಥ":subjects[e].necesaryMarks[subjects[e].selectedEvaluation][a],t+="<div onclick=\"selectInput('in-".concat(e+a,'\')" class="scol').concat(subjects[e].color,' scolN" style="flex-grow: ').concat(100*subjects[e].evaluations[subjects[e].selectedEvaluation].exams[a].weight,'" title="').concat(100*subjects[e].evaluations[subjects[e].selectedEvaluation].exams[a].weight,'%" data-exam="').concat(a,'">').concat(a,'<div id="bar-').concat(e+a,'" data-exam="').concat(a,'">').concat(n,"</div></div>")}else t+="<div onclick=\"selectInput('in-".concat(e+a,'\')" class="scol').concat(subjects[e].color,'" style="flex-grow: ').concat(100*subjects[e].evaluations[subjects[e].selectedEvaluation].exams[a].weight,'" title="').concat(100*subjects[e].evaluations[subjects[e].selectedEvaluation].exams[a].weight,'%" data-exam="').concat(a,'">').concat(a,'<div id="bar-').concat(e+a,'" data-exam="').concat(a,'">').concat(subjects[e].grades[a],"</div></div>");return t}function generateInputs(e){var t="",a={};for(var n in subjects[e].evaluations[subjects[e].selectedEvaluation].exams){var s=subjects[e].evaluations[subjects[e].selectedEvaluation].exams[n];a[s.type]||(a[s.type]={}),a[s.type].weight||(a[s.type].weight=0),a[s.type].inputsHTML||(a[s.type].inputsHTML=""),a[s.type].weight+=s.weight;var o="";o=null==subjects[e].necesaryMarks[subjects[e].selectedEvaluation][n]?"ಥ_ಥ":subjects[e].necesaryMarks[subjects[e].selectedEvaluation][n],isUndone(e,n)?a[s.type].inputsHTML+="<div><span>".concat(n,':</span><input type="number" id="in-').concat(e+n,'" data-exam="').concat(n,'" placeholder="').concat(o,'" value="" class="scol').concat(subjects[e].color,' scolN2" oninput="updateMarkFromCardInput(\'').concat(e,"', '").concat(n,'\', this.value, this);" autocomplete="off" step="0.01" min="0" max="10"></div>'):a[s.type].inputsHTML+="<div><span>".concat(n,':</span><input type="number" id="in-').concat(e+n,'" data-exam="').concat(n,'" placeholder="').concat(o,'" value="').concat(subjects[e].grades[n],'" class="scol').concat(subjects[e].color,'" oninput="updateMarkFromCardInput(\'').concat(e,"', '").concat(n,'\', this.value, this);" autocomplete="off" step="0.01" min="0" max="10"></div>')}for(var c in a)t+="<h3>".concat(c,"</h3><span>").concat(round(100*a[c].weight,0),"%</span><div>").concat(a[c].inputsHTML,"</div>");return t}function generateEvaluations(e){var t='<div class="evaluation-select"'.concat(Object.keys(subjects[e].evaluations).length<=1?' style="display: none;"':"",">\n  <span>Evaluación:</span>\n  <select onchange=\"setSelectedEvaluation('").concat(e,"',this.value);\">");for(var a in subjects[e].evaluations)t+='<option value="'.concat(a,'"').concat(a==subjects[e].selectedEvaluation?'selected="selected"':"",">").concat(a,"</option>");return t+='</select>\n  <img src="media/dislike.svg" style="display: none;" title="Hay otra evaluación mejor">\n</div>'}function addToSubjectsToAdd(e,t){t?subjectsToAdd[e]=null:delete subjectsToAdd[e]}function addSubjects(){for(var e in showLoader("Cargando tus asignaturas","dashboard"),document.getElementById("search-subject-input").value="",subjectsToAdd)null==subjects[e]&&(null==subjectsToAdd[e]?addSubjectFromDB(e):addSubject(e,subjectsToAdd[e]));window.history.back(),searchSubjects()}function addSubject(e,t){subjects[e]=completeSubject(t),createSubjectCardCollapsed(e),updateFinalMark(e),updateNecesaryMark(e),saveSubjectsLocalStorage(),hideLoader("dashboard")}function addSubjectFromDB(t){subjectsDB.doc(t).get().then(function(e){e.exists?addSubject(t,e.data()):console.error("Subject dosen't exists")}).catch(function(e){console.error("Error getting subject (".concat(t,") info:"),e)})}function completeSubject(){for(var e=arguments.length,t=new Array(e),a=0;a<e;a++)t[a]=arguments[a];var n=Object.assign.apply(Object,[{evaluations:{},grades:{},fullName:"",shortName:"",faculty:"",uni:"",course:"",color:1,necesaryMarks:{},finalMark:{}}].concat(t));for(var s in delete n.id,delete n.evaluation,n.selectedEvaluation&&Object.keys(n.evaluations).includes(n.selectedEvaluation)||(n.selectedEvaluation=Object.keys(n.evaluations)[0]||""),n.evaluations)if(!n.necesaryMarks[s]){for(var o in n.necesaryMarks[s]={},n.evaluations[s].exams)n.necesaryMarks[s][o]=n.evaluations[s].passMark;n.finalMark[s]=0}return n}function clearNewSubjectUI(){var e=generateEditSubjectUIHTML("new",completeSubject({creator:displayName,creationDate:{seconds:Math.floor(Date.now()/1e3),nanoseconds:0}}),"new");newSubjectPopup.innerHTML=e}function generateViewSubjectUI(e,t){var a=generateEditSubjectUIHTML(e,t,"view");viewSubjectPopup.innerHTML=a;var n=Object.keys(t.evaluations);for(var s in n)updateSumWeight(viewSubjectPopup,s)}function generateEditSubjectUI(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:subjects[e],a=generateEditSubjectUIHTML(e,t,"edit");editSubjectPopup.innerHTML=a;var n=Object.keys(t.evaluations);for(var s in n)updateSumWeight(editSubjectPopup,s)}function generateEditSubjectUIHTML(e,t,a){var n=toNewEval(t.evaluations),s=Object.keys(t.evaluations),o="",c="",r="",i="",u="",l="";c+='<input style="grid-row: 1; grid-column: '.concat(5+1*s.length,';" class=" edit-new-evaluation" data-evaluation="').concat(s.length,'" type="text" name="evaluationName" value="" placeholder="NEW" autocomplete="off" oninput="updateEvalName(this.dataset.evaluation, this.value, \'').concat(a,"');\">");var d=0;for(var p in n){for(var m in o+='\n    <input style="grid-row: '.concat(2+1*d,'; grid-column: 1;" class="" type="text"   name="exam"       value="').concat(p,'"                 data-exam="').concat(d,'" placeholder="NEW" autocomplete="off" maxlength="5" required>\n    <input style="grid-row: ').concat(2+1*d,'; grid-column: 2;" class="" type="text"   name="examType"   value="').concat(n[p].examType,'" data-exam="').concat(d,'" placeholder="Parciales" required>\n    <input style="grid-row: ').concat(2+1*d,'; grid-column: 3;" class="" type="number" name="mark"       value=""                        data-exam="').concat(d,'" placeholder="-" autocomplete="off" min="0" max="10" step="0.01">'),c+='<div style="grid-row: '.concat(2+1*d,"; grid-column: ").concat(5+1*s.length,';" class="edit-weight edit-new-evaluation" data-exam="').concat(d,'" data-evaluation="').concat(s.length,'"><input type="number" name="weight" value="" placeholder="0" autocomplete="off" min="0" max="100" step="0.0001"></div>'),s)o+='<div style="grid-row: '.concat(2+1*d,"; grid-column: ").concat(5+1*m,';" class="edit-weight" data-exam="').concat(d,'" data-evaluation="').concat(m,'"><input type="number" name="weight" value="').concat(n[p].weight[s[m]]&&0!=n[p].weight[s[m]]?round(100*n[p].weight[s[m]],4):"",'" placeholder="0" autocomplete="off" min="0" max="100" step="0.0001"></div>');++d}for(var v in s)o+='<input style="grid-row: 1; grid-column: '.concat(5+1*v,';" class="edit-evaluationName" type="text" name="evaluationName" value="').concat(s[v],'" data-evaluation="').concat(v,'" placeholder="NEW" autocomplete="off" required oninput="updateEvalName(this.dataset.evaluation, this.value, \'').concat(a,"');\">"),r+='<div style="grid-row: '.concat(2+1*d,"; grid-column: ").concat(5+1*v,';" class="edit-weight edit-new-exam" data-exam="').concat(d,'" data-evaluation="').concat(v,'"><input type="number" name="weight" value="" placeholder="0" autocomplete="off" min="0" max="100" step="0.0001"></div>'),i+='<span  style="grid-row: '.concat(3+1*d,"; grid-column: ").concat(5+1*v,';" class="edit-total" data-evaluation="').concat(v,'">0%</span>'),l+='<label class="edit-conditions-label">'.concat(s[v],'</label><input class="edit-conditions-input" type="text" placeholder="nombreExamen >= 2" name="condition" data-evaluation="').concat(v,'" value="').concat(t.evaluations[s[v]].condition||"",'">');r+='\n  <input style="grid-row: '.concat(2+1*d,'; grid-column: 1;" class="edit-new-exam" type="text"   name="exam"       value="" data-exam="').concat(d,'" placeholder="NEW" autocomplete="off" maxlength="5">\n  <input style="grid-row: ').concat(2+1*d,'; grid-column: 2;" class="edit-new-exam" type="text"   name="examType"   value="" data-exam="').concat(d,'" placeholder="Parciales">\n  <input style="grid-row: ').concat(2+1*d,'; grid-column: 3;" class="edit-new-exam" type="number" name="mark"       value="" data-exam="').concat(d,'" placeholder="-" autocomplete="off" min="0" max="10" step="0.01">\n  ');for(var b=0,f=[1,8,3,4,6,5,2,7];b<f.length;b++){var y=f[b];u+='\n    <label class="scol'.concat(y,'"  for="color-bar-').concat(a,"-elem").concat(y,'">\n      <input type="radio" name="color-bar" value="').concat(y,'" id="color-bar-').concat(a,"-elem").concat(y,'" ').concat(y==t.color?"checked":"",'>\n      <span class="edit-color-checkmark"></span>\n    </label>')}return'\n  <h2>Información</h2>\n  <input type="hidden" name="id" id="'.concat(a,'-id" value="').concat(e,'" style="display: none;" hidden>\n  <div class="edit-popup-info">\n    <div>\n      <label for="').concat(a,'-shortName">Nombre</label>\n      <input type="text" name="shortName" id="').concat(a,'-shortName" value="').concat(t.shortName,'" placeholder="M2" required>\n    </div>\n    <div class="edit-fullName">\n      <label for="').concat(a,'-fullName">Nombre Largo</label>\n      <input type="text" name="fullName" id="').concat(a,'-fullName" value="').concat(t.fullName?t.fullName:"",'" placeholder="Matemáticas 2" required>\n    </div>\n  </div>\n  <div class="edit-popup-info">\n    <div>\n      <label for="').concat(a,'-course">Curso</label>\n      <input type="text" name="course" id="').concat(a,'-course" value="').concat(t.course?t.course:"",'" placeholder="Q1 2019-2020" required>\n    </div>\n    <div>\n      <label for="').concat(a,'-faculty">Facultad</label>\n      <input type="text" name="faculty" id="').concat(a,'-faculty" value="').concat(t.faculty?t.faculty:"",'" placeholder="FIB" required>\n    </div>\n    <div>\n      <label for="').concat(a,'-uni">Universidad</label>\n      <input type="text" name="uni" id="').concat(a,'-uni" value="').concat(t.uni?t.uni:"",'" placeholder="UPC" required>\n    </div>\n  </div>\n  <div class="color-bar">\n    ').concat(u,'\n    \x3c!-- <label class="scol0"  for="color-bar-elem0">\n      <input type="radio" name="color-bar" value="0" id="color-bar-elem0">\n      <span class="edit-color-checkmark edit-color-checkmark-random"></span>\n    </label> --\x3e\n  </div>\n\n  <div class="edit-popup-info">\n    <div>\n      <span>Fecha de creación: <span id="').concat(a,'-creationDate">').concat(t.creationDate?new Date(1e3*t.creationDate.seconds).toLocaleDateString("es-ES"):"--/--/----",'</span></span>\n    </div>\n    <div>\n      <span>Creador: <span id="').concat(a,'-creator">').concat(t.creator?t.creator:"Anónimo",'</span></span>\n    </div>\n  </div>\n\n  <h2>Evaluación</h2>\n  <div class="edit-popup-grid" onkeyup="editUIUpdateGrid(this, event, \'').concat(a,'\');" data-evaluations="').concat(s.length,'" data-exams="').concat(d,'">\n    \x3c!-- Header --\x3e\n    <span  style="grid-row: 1; grid-column: 1;" >Nombre</span>\n    <span  style="grid-row: 1; grid-column: 2;" >Categoría</span>\n    <span  style="grid-row: 1; grid-column: 3;" >Nota</span>\n\n    \x3c!-- Body --\x3e\n    ').concat(o,'\n    \x3c!-- Divider --\x3e\n    <div style="grid-row: 2 / ').concat(2+d,';" class="grid-separator-evaluation"></div>\n\n    \x3c!-- new --\x3e\n    ').concat(c,"\n    ").concat(r,"\n\n    \x3c!-- Footer --\x3e\n    ").concat(i,'\n    \n  </div>\n\n  <h2 style="display: none;" >Condiciones extra para aprovar</h2>\n  <div style="display: none;" class="edit-conditions">\n    ').concat(l,"\n  </div>")}function updateEvalName(e,t,a){var n=document.querySelector("#".concat(a,"-popup-content .edit-conditions-label[data-evaluation='").concat(e,"']"));n&&(n.textContent=t||"")}function updateAndDisplayMarks(e){updateFinalMark(e,!(1<arguments.length&&void 0!==arguments[1])||arguments[1]),updateNecesaryMark(e),displayFinalMark(e),displayNecesaryMark(e),congratulate()}function displayNecesaryMark(e){var t=getCard(e),a=t.getElementsByClassName("scolN"),n=t.getElementsByClassName("scolN2"),s=!0,o=!1,c=void 0;try{for(var r,i=a[Symbol.iterator]();!(s=(r=i.next()).done);s=!0){var u=r.value,l="";l=null==subjects[e].necesaryMarks[subjects[e].selectedEvaluation][u.dataset.exam]?"ಥ_ಥ":subjects[e].necesaryMarks[subjects[e].selectedEvaluation][u.dataset.exam],u.children[0].textContent=l}}catch(e){o=!0,c=e}finally{try{s||null==i.return||i.return()}finally{if(o)throw c}}for(var d=0;d<n.length;d++){var p="";p=null==subjects[e].necesaryMarks[subjects[e].selectedEvaluation][n[d].dataset.exam]?"ಥ_ಥ":subjects[e].necesaryMarks[subjects[e].selectedEvaluation][n[d].dataset.exam],n[d].placeholder=p}}function displayFinalMark(e){var t=getCard(e).getElementsByClassName("subject-finalMark")[0];t.textContent=subjects[e].finalMark[subjects[e].selectedEvaluation],t.style.color=isPassed(e,subjects[e].selectedEvaluation)?"#5a9764":"#b9574c"}function updateNecesaryMark(e){var t=subjects[e].selectedEvaluation,a=getConditionIdentifiers(e,t);for(var n in subjects[e].necesaryMarks[t])subjects[e].necesaryMarks[t][n]=void 0;for(var s in a.exams)switch(a.exams[s].operator){case">=":subjects[e].necesaryMarks[t][s]=a.exams[s].value}for(var o in a.types)switch(a.types[o].operator){case">=":for(var c in subjects[e].necesaryMarks[t])subjects[e].evaluations[t].exams[c].type==o&&void 0!==subjects[e].necesaryMarks[t][c]&&subjects[e].necesaryMarks[t][c]<a.types[o].value&&(subjects[e].necesaryMarks[t][c]=a.types[o].value)}gradeCalcAllEqual(e,subjects[e].selectedEvaluation);var r=getBestEval(e)===subjects[e].selectedEvaluation,i=getCard(e);i&&(i.querySelector(".evaluation-select > img").style.display=r?"none":"block")}function getBestEval(e){var t,a;for(var n in subjects[e].evaluations){var s=void 0;for(var o in subjects[e].evaluations[n].exams)(null==s||s<subjects[e].necesaryMarks[n][o])&&(s=subjects[e].necesaryMarks[n][o]),(null==a||s<a)&&(a=subjects[e].necesaryMarks[n][o],t=n)}return t}function smallestNecessaryMark(e,t){var a={};for(var n in subjects[e].necesaryMarks[t])(void 0===a.mark||a.mark<subjects[e].necesaryMarks[t][n])&&(a.exam=n,a.mark=subjects[e].necesaryMarks[t][n]);return a}function updateFinalMark(e){var t=!(1<arguments.length&&void 0!==arguments[1])||arguments[1];for(var a in subjects[e].evaluations){for(var n in subjects[e].finalMark[a]=0,subjects[e].evaluations[a].exams)isUndone(e,n)||(subjects[e].finalMark[a]+=subjects[e].grades[n]*subjects[e].evaluations[a].exams[n].weight);subjects[e].finalMark[a]=round(subjects[e].finalMark[a])}var s=isPassed(e);return t&&!subjects[e].passed&&s&&showConfetti(getCard(e)),subjects[e].passed=s,subjects[e].finalMark[subjects[e].selectedEvaluation]}function updateMarkFromCardInput(e,t,a,n){var s=getBarElem(e,t);isNaN(a)||""==a?(delete subjects[e].grades[t],uploadGrade(e,t,void 0),s.parentElement.classList.add("scolN"),n.classList.add("scolN2")):(subjects[e].passed=isPassed(e),subjects[e].grades[t]=Number(a),uploadGrade(e,t,subjects[e].grades[t]),s.parentElement.classList.remove("scolN"),n.classList.remove("scolN2")),updateAndDisplayMarks(e),saveSubjectsLocalStorage()}function updateCardGrades(e){var t=getCard(e),a=!0,n=!1,s=void 0;try{for(var o,c=t.getElementsByClassName("subject-bar")[0].children[Symbol.iterator]();!(a=(o=c.next()).done);a=!0){o.value.classList.add("scolN")}}catch(e){n=!0,s=e}finally{try{a||null==c.return||c.return()}finally{if(n)throw s}}for(var r in subjects[e].evaluations[subjects[e].selectedEvaluation].exams){var i=getInput(e,r);i.classList.add("scolN2"),i.value=""}for(var u in subjects[e].grades){var l=getBarElem(e,u),d=getInput(e,u);l&&d?(l.textContent=subjects[e].grades[u],l.parentElement.classList.remove("scolN"),d.value=subjects[e].grades[u],d.classList.remove("scolN2")):console.log("Exam ".concat(u," of ").concat(subjects[e].shortName," (").concat(e,") is not in the card"))}updateAndDisplayMarks(e)}function setSelectedEvaluation(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:subjects[e].selectedEvaluation;subjects[e].selectedEvaluation=t,saveSubjectsLocalStorage();var a=getCard(e);a.getElementsByClassName("subject-bar")[0].innerHTML=generateBar(e),a.getElementsByClassName("grades-input")[0].innerHTML=generateInputs(e)+generateEvaluations(e,t),updateHeigth(a.getElementsByClassName("grades-input")[0]),updateAndDisplayMarks(e)}function showConfetti(e,t){null==t&&(t={angle:random(60,70),spread:random(40,50),startVelocity:random(60,90),elementCount:random(30,60),decay:.8,colors:["#E68F17","#FAB005","#FA5252","#E64980","#BE4BDB","#0B7285","#15AABF","#EE1233","#40C057"]}),window.confetti(e,t)}function getCard(e){var t=document.getElementById("card-"+e);return t||(createSubjectCardCollapsed(e),t=document.getElementById("card-"+e)),t}function getInput(e,t){var a=document.getElementById("in-"+e+t);return a||(createSubjectCardCollapsed(e),a=document.getElementById("in-"+e+t)),a}function getBarElem(e,t){var a=document.getElementById("bar-"+e+t);return a||(createSubjectCardCollapsed(e),a=document.getElementById("bar-"+e+t)),a}function gradeCalcAllEqual(e,t){var a=0,n=[],s=0;for(var o in subjects[e].evaluations[t].exams)isUndone(e,o)?null==subjects[e].necesaryMarks[t][o]?(a+=subjects[e].evaluations[t].exams[o].weight,n.push(o)):s+=subjects[e].evaluations[t].exams[o].weight*subjects[e].necesaryMarks[t][o]:s+=subjects[e].evaluations[t].exams[o].weight*subjects[e].grades[o];var c=((subjects[e].evaluations[t].passMark||5)-s)/a,r=smallestNecessaryMark(e,t);if(null!=r.mark&&r.mark<c)subjects[e].necesaryMarks[t][r.exam]=void 0,gradeCalcAllEqual(e,t);else{var i=calcCondition(e,t,!1);for(var u in subjects[e].evaluations[t].exams)subjects[e].necesaryMarks[t][u]||(isUndone(e,u)?subjects[e].necesaryMarks[t][u]=!1===i?null:Math.max(0,round(c)):subjects[e].necesaryMarks[t][u]=subjects[e].grades[u])}}function round(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:2;return isNaN(e)||""===e||null==e?void 0:Math.floor(Math.round(e*Math.pow(10,t)))/Math.pow(10,t)}function random(e,t){return Math.floor(Math.random()*(t-e))+e}function ShowEasterEgg(){document.getElementById("congratulations-button").style.display="none",document.getElementById("congratulations").style.display="block",document.getElementById("congratulations-border").style.display="block",document.body.classList.add("rainbow-bg"),75*document.documentElement.clientWidth<50*document.documentElement.clientHeight?document.body.style.paddingBottom="75vw":document.getElementsByTagName("body")[0].style.paddingBottom="50vh",null!=congratulationsVideo&&(congratulationsVideo.setVolume(100),congratulationsVideo.playVideo())}function HideEasterEgg(){document.getElementById("congratulations").style.display="none",document.getElementById("congratulations-border").style.display="none",document.body.classList.remove("rainbow-bg"),document.body.style.paddingBottom="0",null!=congratulationsVideo&&congratulationsVideo.pauseVideo(),congratulate()}function onYouTubeIframeAPIReady(){congratulationsVideo=new YT.Player("congratulations")}function congratulate(){hasPassedEverything()?(document.getElementById("congratulations-gift").src="media/gift_jump_once.gif?n=".concat(Math.random()),document.getElementById("congratulations-button").style.display="block"):document.getElementById("congratulations-button").style.display="none"}function hasPassedEverything(){if(isEmpty(subjects))return!1;for(var e in subjects)if(!isPassed(e))return!1;return!0}function isPassed(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:subjects[e].selectedEvaluation;return null!=subjects[e].evaluations[t]&&subjects[e].finalMark[t]>=(subjects[e].evaluations[t].passMark||5)&&calcCondition(e,t)}function getExamTypesGrades(e,t){var a={};for(var n in subjects[e].evaluations[t].exams){var s=subjects[e].evaluations[t].exams[n];a[s.type]||(a[s.type]=0),a[s.type]+=s.weight*(subjects[e].grades[n]||0)}return a}function getConditionIdentifiers(e,t){if(!subjects[e].evaluations[t].condition)return!0;var a={exams:{},evaluations:{},types:{}};return findIdentifiersTree(jsep(subjects[e].evaluations[t].condition),a,Object.keys(getExamTypesGrades(e,t)),e,t),a}function findIdentifiersTree(e,t,a,n,s){switch(e.type){case"LogicalExpression":case"BinaryExpression":"Identifier"==e.left.type&&"Literal"==e.right.type?t[identifierCategory(e.left.name,n,s,a)][e.left.name]={value:e.right.value,operator:e.operator}:(findIdentifiersTree(e.left,t,a,n,s),findIdentifiersTree(e.right,t,a,n,s))}}function identifierCategory(e,t,a){var n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:void 0;return Object.keys(subjects[t].evaluations[a].exams).includes(e)?"exams":Object.keys(subjects[t].evaluations).includes(e)?"evaluations":(null==n&&(n=Object.keys(getExamTypesGrades(t,a))),n.includes(e)?"types":void 0)}function calcCondition(e,t){var a=!(2<arguments.length&&void 0!==arguments[2])||arguments[2];return!subjects[e].evaluations[t].condition||evaluationTree(jsep(subjects[e].evaluations[t].condition),_objectSpread({},subjects[e].grades,subjects[e].finalMark,getExamTypesGrades(e,t)),a)}function evaluationTree(e,t,a){switch(e.type){case"LogicalExpression":switch(e.operator){case"&&":return evaluationTree(e.left,t,a)&&evaluationTree(e.right,t,a);default:return null}break;case"BinaryExpression":switch(e.operator){case">=":return"Identifier"!=e.left.type||"Literal"!=e.right.type?null:!a&&null==t[e.left.name]||(t[e.left.name]||0)>=e.right.value;case"<":return"Identifier"!=e.left.type||"Literal"!=e.right.type||"evaluations"!=identifierCategory(e.left.name)?null:!a&&null==t[e.left.name]||(t[e.left.name]||0)<e.lerightft.value;default:return null}break;case"Literal":return e.value;case"Identifier":return t[e.name]||0;default:return null}}function toggleExpandCard(e,t){var a=t.getElementsByClassName("grades-input")[0],n=t.getElementsByClassName("subject-bar")[0];["INPUT","SELECT","OPTION","BUTTON","IMG"].includes(e.target.tagName)||(n.contains(e.target)?a.classList.remove("hidden"):a.classList.toggle("hidden"),updateHeigth(a))}function updateHeigth(e){e.style.height=(e.classList.contains("hidden")?0:e.scrollHeight)+"px"}function selectInput(e){document.getElementById(e).select()}function appendElement(e,t){var a=document.createElement("div");a.innerHTML=t.trim();var n=a.firstChild;return e.appendChild(n),n}router.on({"/user/:id":{as:"user.view",uses:setPageUser},"/me":{as:"me",uses:setPageMe},"/me/edit":{as:"me.edit",uses:setPageMeEdit},"/me/subjects/:id/edit":{as:"me.subject.edit",uses:setPageMeSubjectEdit},"/me/subjects/add":{as:"me.subject.add",uses:setPageMeSubjectAdd},"/subjects/new":{as:"subject.new",uses:setPageSubjectNew},"/subjects/:id":{as:"subject.view",uses:setPageSubjectView},"/subjects/:id/edit":{as:"subject.edit",uses:setPageSubjectEdit},"*":{as:"dashboard",uses:setPageDashboard}}).resolve(),updateCards();var cardsOldInfo={},cardsNewInfo=cardsOldInfo;function removeCard(e){cardsOldInfo=getCardsInfo(),e.parentNode.removeChild(e),cardsNewInfo=getCardsInfo(),moveCards()}function getCardsInfo(){updateCards();var a={};return cards.forEach(function(e){var t=e.getBoundingClientRect();a[e.id]={x:t.left,y:t.top,width:t.right-t.left}}),a}function moveCards(){updateCards(),cards.forEach(function(e){e.animate([{transform:"translate(".concat(cardsOldInfo[e.id].x-cardsNewInfo[e.id].x,"px, ").concat(cardsOldInfo[e.id].y-cardsNewInfo[e.id].y,"px) scaleX(").concat(cardsOldInfo[e.id].width/cardsNewInfo[e.id].width,")")},{transform:"none"}],{duration:250,easing:"ease-out"})})}function updateCards(){cards=document.querySelectorAll(".subject-card")}function isUndone(e,t){return void 0===subjects[e].grades[t]}function isEmpty(e){for(var t in e)if(e.hasOwnProperty(t))return!1;return!0}function showToast(e,t,a){var n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:8e3;toast.style.display="none",toast.style.animation="goUp 500ms cubic-bezier(0.215, 0.61, 0.355, 1), fadeOut ".concat(Math.max(0,n-3e3),"ms 2.5s cubic-bezier(1, 0, 1, 1), opaque 2.5s"),toast.offsetHeight,toast.style.display="flex",toast.firstChild.innerHTML="<p>".concat(e,"</p>"),t&&a&&(toast.firstChild.innerHTML+='<button onclick="'.concat(a,'">').concat(t,"</button>")),clearTimeout(toastTimer),toastTimer=setTimeout(function(){toast.style.display="none"},n)}function showLoader(e,t){var a=document.getElementById(t+"-loader");a.lastElementChild.textContent=e,a.style.display="block"}function hideLoader(e){document.getElementById(e+"-loader").style.display="none"}function getSubjectsLocalStorage(){return JSON.parse(localStorage.getItem("subjects"))||{}}function saveSubjectsLocalStorage(){return localStorage.setItem("subjects",JSON.stringify(subjects||{})),subjects}function toNewEvalNeeeeeeeeew(e){var t={};for(var a in e){if(e[a].exams)return e;for(var n in t[a]={},t[a].condition="",t[a].passMark=5,t[a].exams={},e[a])for(var s in e[a][n])t[a].exams[s]={},t[a].exams[s].weight=e[a][n][s],t[a].exams[s].type=n}return t}function toNewEval(e){var t={};for(var a in e)for(var n in e[a].exams)t[n]||(t[n]={}),t[n].weight||(t[n].weight={}),t[n].weight[a]=e[a].exams[n].weight,t[n].mark=e[a].exams[n].mark,t[n].examType=e[a].exams[n].type;return t}function updateSumWeight(e,t){var a=0,n=!0,s=!1,o=void 0;try{for(var c,r=e.querySelectorAll(".edit-weight[data-evaluation='".concat(t,"'] > input"))[Symbol.iterator]();!(n=(c=r.next()).done);n=!0){a+=1*c.value.value}}catch(e){s=!0,o=e}finally{try{n||null==r.return||r.return()}finally{if(s)throw o}}return e.querySelector(".edit-total[data-evaluation='".concat(t,"']")).textContent=round(a,4)+"%",a}function freeze(){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:10;frozenLayerMessage=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"",frozenLayer.style.display="flex",frozenLayer.style.opacity=1,frozenLayerWarning.style.display="none",frozenWarningTimeout=setTimeout(function(){frozenLayerWarning.style.display="inline-block"},1e3*e)}function unfreeze(){frozenLayerMessage="Cargando...",frozenLayer.style.display="none",frozenLayer.style.opacity=0,clearTimeout(frozenWarningTimeout),frozenLayerWarning.style.display="none"}function editUIUpdateGrid(e,t,a){var n=t.target,s=n.parentNode==e?n:n.parentNode,o=e.parentNode.lastElementChild;if(n.value)if(parseInt(s.dataset.evaluation)==parseInt(e.dataset.evaluations)){++e.dataset.evaluations,appendElement(e,'<input style="grid-row: 1; grid-column: '.concat(5+parseInt(e.dataset.evaluations),';" class="edit-new-evaluation" data-evaluation="').concat(e.dataset.evaluations,'" type="text" name="evaluationName" value="" placeholder="NEW" autocomplete="off" oninput="updateEvalName(this.dataset.evaluation, this.value, \'').concat(a,"');\">"));for(var c=0;c<parseInt(e.dataset.exams);c++)editGridFadeOrUnfade(e,appendElement(e,'<div style="grid-row: '.concat(2+1*c,"; grid-column: ").concat(5+parseInt(e.dataset.evaluations),';" class="edit-weight edit-new-evaluation" data-exam="').concat(c,'" data-evaluation="').concat(e.dataset.evaluations,'" ><input type="number" name="weight" value="" placeholder="0" autocomplete="off" min="0" max="100" step="0.0001"></div>')),["exam"]);appendElement(e,'<div style="grid-row: '.concat(2+parseInt(e.dataset.exams),"; grid-column: ").concat(4+parseInt(e.dataset.evaluations),';" class="edit-weight edit-new-exam" data-exam="').concat(e.dataset.exams,'" data-evaluation="').concat(e.dataset.evaluations-1,'" ><input type="number" name="weight" value="" placeholder="0" autocomplete="off" min="0" max="100" step="0.0001"></div>')),appendElement(e,'<span style="grid-row: '.concat(3+parseInt(e.dataset.exams),"; grid-column: ").concat(4+parseInt(e.dataset.evaluations),';" class="edit-total" data-evaluation="').concat(-1+parseInt(e.dataset.evaluations),'">0%</span>')),appendElement(o,'<label class="edit-conditions-label" data-evaluation="'.concat(parseInt(e.dataset.evaluations)-1,'"></label>')),appendElement(o,'<input class="edit-conditions-input" type="text" placeholder="nombreExamen >= 2" name="condition" data-evaluation="'.concat(parseInt(e.dataset.evaluations)-1,'">')),(n.name="evaluationName")&&updateEvalName(parseInt(e.dataset.evaluations)-1,n.value,a)}else if(parseInt(s.dataset.exam)==parseInt(e.dataset.exams)){++e.dataset.exams,appendElement(e,'<input style="grid-row: '.concat(2+parseInt(e.dataset.exams),'; grid-column: 1;" class="edit-new-exam" type="text"   name="exam"       value="" data-exam="').concat(e.dataset.exams,'" placeholder="NEW" autocomplete="off" maxlength="5">')),appendElement(e,'<input style="grid-row: '.concat(2+parseInt(e.dataset.exams),'; grid-column: 2;" class="edit-new-exam" type="text"   name="examType"   value="" data-exam="').concat(e.dataset.exams,'" placeholder="Parciales">')),appendElement(e,'<input style="grid-row: '.concat(2+parseInt(e.dataset.exams),'; grid-column: 3;" class="edit-new-exam" type="number" name="mark"       value="" data-exam="').concat(e.dataset.exams,'" placeholder="-" autocomplete="off" min="0" max="10" step="0.01">'));for(var r=0;r<e.dataset.evaluations;r++)editGridFadeOrUnfade(e,appendElement(e,'<div style="grid-row: '.concat(2+parseInt(e.dataset.exams),"; grid-column: ").concat(5+1*r,';" class="edit-weight edit-new-exam" data-exam="').concat(e.dataset.exams,'" data-evaluation="').concat(r,'"><input type="number" name="weight" value="" placeholder="0" autocomplete="off" min="0" max="100" step="0.0001"></div>')),["exam"]);appendElement(e,'<div style="grid-row: '.concat(1+parseInt(e.dataset.exams),"; grid-column: ").concat(5+parseInt(e.dataset.evaluations),';" class="edit-weight edit-new-evaluation" data-exam="').concat(-1+parseInt(e.dataset.exams),'" data-evaluation="').concat(e.dataset.evaluations,'" ><input type="number" name="weight" value="" placeholder="0" autocomplete="off" min="0" max="100" step="0.0001"></div>'));var i=!0,u=!1,l=void 0;try{for(var d,p=e.querySelectorAll(".edit-total")[Symbol.iterator]();!(i=(d=p.next()).done);i=!0){d.value.style.gridRow=3+parseInt(e.dataset.exams)}}catch(e){u=!0,l=e}finally{try{i||null==p.return||p.return()}finally{if(u)throw l}}}editGridFadeOrUnfade(e,s),!s.classList.contains("edit-weight")||s.classList.contains("edit-new-evaluation")||s.classList.contains("edit-new-exam")||""==s.value||updateSumWeight(e,s.dataset.evaluation)}function editGridFadeOrUnfade(e,t){var a=2<arguments.length&&void 0!==arguments[2]?arguments[2]:["exam","evaluation"],n=!0,s=!1,o=void 0;try{for(var c,r=a[Symbol.iterator]();!(n=(c=r.next()).done);n=!0){var i=c.value;null!=t.dataset[i]&&parseInt(t.dataset[i])<parseInt(e.dataset[i+"s"])&&(editGridIsEmpty(e,i,parseInt(t.dataset[i]))?editGridFade(e,i,parseInt(t.dataset[i])):editGridUnfade(e,i,parseInt(t.dataset[i])))}}catch(e){s=!0,o=e}finally{try{n||null==r.return||r.return()}finally{if(s)throw o}}e.querySelector(".grid-separator-evaluation").style.gridRow="2 / ".concat(2+parseInt(e.dataset.exams))}function editGridUnfade(e,t,a){var n=!0,s=!1,o=void 0;try{for(var c,r=e.querySelectorAll("*[data-".concat(t,"='").concat(a,"'"))[Symbol.iterator]();!(n=(c=r.next()).done);n=!0){var i=c.value;(null==i.dataset.evaluation||parseInt(i.dataset.evaluation)<parseInt(e.dataset.evaluations))&&(null==i.dataset.exam||parseInt(i.dataset.exam)<parseInt(e.dataset.exams))&&(i.classList.remove("edit-new-exam"),i.classList.remove("edit-new-evaluation"),["exam","examType","evaluationName"].includes(i.name)&&(i.required=!0))}}catch(e){s=!0,o=e}finally{try{n||null==r.return||r.return()}finally{if(s)throw o}}}function editGridFade(e,t,a){var n=!1,s=!0,o=!1,c=void 0;try{for(var r,i=e.querySelectorAll("*[data-".concat(t,"]"))[Symbol.iterator]();!(s=(r=i.next()).done);s=!0){var u=r.value;if(parseInt(u.dataset[t])==a)u.classList.add("edit-new-".concat(t)),u.required=!1,u.parentNode.removeChild(u),n=!0;else if(parseInt(u.dataset[t])>a)switch(u.dataset[t]=parseInt(u.dataset[t])-1,t){case"evaluation":u.style.gridColumn="".concat(parseInt(u.dataset[t])+5," / auto");break;case"exam":u.style.gridRow="".concat(parseInt(u.dataset[t])+2," / auto")}}}catch(e){o=!0,c=e}finally{try{s||null==i.return||i.return()}finally{if(o)throw c}}var l=e.parentNode.lastElementChild,d=!0,p=!1,m=void 0;try{for(var v,b=l.querySelectorAll("*[data-".concat(t,"]"))[Symbol.iterator]();!(d=(v=b.next()).done);d=!0){var f=v.value;parseInt(f.dataset[t])==a?(f.classList.add("edit-new-".concat(t)),f.parentNode.removeChild(f)):parseInt(f.dataset[t])>a&&(f.dataset[t]=parseInt(f.dataset[t])-1)}}catch(e){p=!0,m=e}finally{try{d||null==b.return||b.return()}finally{if(p)throw m}}n&&(e.dataset[t+"s"]=parseInt(e.dataset[t+"s"])-1)}function editGridIsEmpty(e,t,a){var n=!0,s=!1,o=void 0;try{for(var c,r=e.querySelectorAll("input[data-".concat(t,"='").concat(a,"'], div[data-").concat(t,"='").concat(a,"'] > input"))[Symbol.iterator]();!(n=(c=r.next()).done);n=!0){if(c.value.value)return!1}}catch(e){s=!0,o=e}finally{try{n||null==r.return||r.return()}finally{if(s)throw o}}return!0}function saveEditSubject(){var e=readSubjectFromPopup(editSubjectPopup),t=e.id;e.shortName!=subjects[t].shortName&&uploadShortName(t,e.shortName),e.fullName!=subjects[t].fullName&&uploadFullName(t,e.fullName),e.course!=subjects[t].course&&uploadCourse(t,e.course),e.faculty!=subjects[t].faculty&&uploadFaculty(t,e.faculty),e.uni!=subjects[t].uni&&uploadUni(t,e.uni),e.color!=subjects[t].color&&uploadColor(t,e.color),JSON.stringify(e.evaluations)===JSON.stringify(subjects[t].evaluations)&&uploadEvaluation(t,e.evaluations),subjects[t]=completeSubject(subjects[t],e),updateSubjectCardInfo(t),saveSubjectsLocalStorage(),hideLoader("dashboard")}function readSubjectFromPopup(e){for(var t=e.querySelector('input[name="id"]').value,a={},n=e.querySelector(".edit-popup-grid"),s=0;s<parseInt(n.dataset.evaluations);s++){var o=n.querySelector("input[name='evaluationName'][data-evaluation='".concat(s,"']"));if(o){var c=o.value;if(c){for(var r=0;r<parseInt(n.dataset.exams);r++){var i=n.querySelector("input[name='exam'][data-exam='".concat(r,"']")).value,u=n.querySelector("input[name='examType'][data-exam='".concat(r,"']")).value,l=n.querySelector("div[data-exam='".concat(r,"'][data-evaluation='").concat(s,"'] > input[name='weight']")).value/100;i&&u&&l&&(a[c]||(a[c]={}),a[c].exams||(a[c].exams={}),a[c].exams[i]||(a[c].exams[i]={}),a[c].exams[i].weight=l,a[c].exams[i].type=u)}var d=e.querySelector("input[name='condition'][data-evaluation='".concat(s,"']")).value;d&&(a[c].condition=d)}}}return console.log(a),{id:t,shortName:e.querySelector('input[name="shortName"]').value,fullName:e.querySelector('input[name="fullName"]').value,course:e.querySelector('input[name="course"]').value,faculty:e.querySelector('input[name="faculty"]').value,uni:e.querySelector('input[name="uni"]').value,color:e.querySelector('input[name="color-bar"]:checked').value,evaluations:a}}function saveViewSubject(){var e=readSubjectFromPopup(viewSubjectPopup),t=e.id;isValidSubjectFromPopup(e)&&(subjectsToAdd[t]=e)}function saveNewSubject(){return _saveNewSubject.apply(this,arguments)}function _saveNewSubject(){return(_saveNewSubject=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(delete(t=readSubjectFromPopup(newSubjectPopup)).id,isValidSubjectFromPopup(t))return freeze("Creando asignatura",10),e.next=6,uploadSubject(t);e.next=11;break;case 6:a=e.sent,unfreeze(),a||showToast("Error al subir"),addSubject(a,t),router.navigate("/");case 11:case"end":return e.stop()}},e)}))).apply(this,arguments)}function deleteSubject(e){if(removedSubject=subjects[e],delete subjects[removedSubjectId=e],saveSubjectsLocalStorage(),!isAnonymous){var t={};t["subjects."+e]=firebase.firestore.FieldValue.delete(),userDB.update(t)}removeCard(getCard(e)),showToast("Has borrado <b>".concat(removedSubject.shortName,"</b>"),"Deshacer","undoRemoveSubject();"),isEmpty(subjects)&&showTutorial(),congratulate()}function undoRemoveSubject(){var e=removedSubjectId;if(subjects[e]=removedSubject,createSubjectCardCollapsed(e),saveSubjectsLocalStorage(),!isAnonymous){var t={};t["subjects."+e+".grades"]=subjects[e].grades,userDB.update(t)}clearTimeout(toastTimer),document.getElementById("toast").style.display="none"}function hideTutorial(){document.getElementById("tutorial").style.display="none",document.getElementById("add-button-topbar").classList.remove("focus-animation-loop")}function showTutorial(){document.getElementById("tutorial").style.display="block"}var deferredPrompt,provider=new firebase.auth.GoogleAuthProvider;function loginGoogle(){showLoader("Redireccionando","login"),firebase.auth().signInWithRedirect(provider),hideLoader("login")}function logoutGoogle(){firebase.auth().signOut()}function uploadSubject(t){if(uid&&null!=t&&null!=t&&""!=t&&t!={}&&t!=[])return subjectsDB.add(_objectSpread({creator:displayName,creatorId:uid,creationDate:new Date},t)).then(function(e){return console.log("Created ".concat(t.shortName," with id ").concat(e.id)),e.id}).catch(function(e){return console.error("Error creating subject ",e),!1})}function isValidSubjectFromPopup(e){console.log(e),console.log(isEmpty(e));var t="";if(!e.shortName)return showToast("Rellena el Nombre"),!1;if(!e.fullName)return showToast("Rellena el Nombre Largo"),!1;if(!e.course)return showToast("Rellena el Curso"),!1;if(!e.faculty)return showToast("Rellena la Facultad"),!1;if(!e.uni)return showToast("Rellena la Universidad"),!1;if(!e.color)return showToast("Escoje un Color"),!1;if(isEmpty(e.evaluations))return showToast("Rellena ela Evaluación"),!1;for(var a in e.evaluations)if(isEmpty(e.evaluations[a].exams)){t=a;break}if(t)return showToast("Pon almenos un examen en ".concat(t)),!1;for(var n in e.evaluations)for(var s in e.evaluations[n].exams)if(!e.evaluations[n].exams[s].type){t=s;break}return!t||(showToast("Pon categoria al examen ".concat(t)),!1)}function uploadGrade(e,t,a){return uploadToUserDB("subjects.".concat(e,".grades.").concat(t),a)}function uploadEvaluation(e,t){return uploadToUserDB("subjects.".concat(e,".evaluations"),t)}function uploadColor(e,t){return uploadToUserDB("subjects.".concat(e,".color"),parseInt(t))}function uploadShortName(e,t){return uploadToUserDB("subjects.".concat(e,".shortName"),t)}function uploadFullName(e,t){return uploadToUserDB("subjects.".concat(e,".fullName"),t)}function uploadCourse(e,t){return uploadToUserDB("subjects.".concat(e,".course"),t)}function uploadFaculty(e,t){return uploadToUserDB("subjects.".concat(e,".faculty"),t)}function uploadUni(e,t){return uploadToUserDB("subjects.".concat(e,".uni"),t)}function uploadVersion(e,t){return uploadToUserDB("subjects.".concat(e,".version"),t)}function uploadToUserDB(e,t){return uploadToDB(userDB,e,t)}function uploadToSubjectsDB(e,t,a){return uploadToDB(subjectsDB.doc(e),t,a)}function uploadToDB(e,t,a){if(!isAnonymous){var n={};return t?n[t]=null!=a&&null!=a&&""!=a&&a!={}&&a!=[]?a:firebase.firestore.FieldValue.delete():n=a,e.update(n)}}function getAndDisplayUserSubjects(){isAnonymous?(console.warn("To get user info you need to sign in"),showToast("Guarda tus notas en la nube","Iniciar sesión","loginGoogle();"),hideLoader("dashboard")):(showLoader("Descargando asignaturas","dashboard"),userDB.get().then(function(a){a.exists?function(){function e(a){subjectsDB.doc(a).get().then(function(e){if(e.exists){var t=e.data();subjects[a]||(subjects[a]={}),n.subjects[a]||(n.subjects[a]={}),subjects[a]=completeSubject(t,subjects[a],n.subjects[a],{grades:subjects[a].grades||n.subjects[a].grades?Object.assign({},subjects[a].grades,n.subjects[a].grades):t.grades}),updateFinalMark(a),updateNecesaryMark(a),updateCardGrades(a),saveSubjectsLocalStorage(),console.info("Loaded subject: ".concat(subjects[a].shortName," - ").concat(a))}else console.error("Subject ".concat(a," dosen't exist"),n.subjects[a])}).catch(function(e){console.error("Error getting subject (".concat(a,") info:"),e)})}var n=a.data();for(var t in n.subjects)e(t);console.info("User has ".concat(n.subjects.length," saved subjects"))}():(userDB.set({}),console.error("User ".concat(uid," dosen't exist"),userInfo.subjects[id])),hideLoader("dashboard")}).catch(function(e){console.error("Error getting user info:",e),hideLoader("dashboard")}))}function getSubjectsAllDB(){return subjectsDB.get()}function searchSubjects(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"";""!=(t=t.trim())?index.search(t).then(function(e){console.log("Results for ".concat(t,":"),e.hits),searchResultsSubject.innerHTML=e.hits.reduce(function(e,t){return e+generateSearchResultSubject(t._highlightResult,t.objectID)},""),0==e.nbHits?(searchCreateDiv.style.display="block",searchResultsNone.style.display="block"):(searchCreateDiv.style.display="none",searchResultsNone.style.display="none")}):(searchResultsSubject.innerHTML="",searchCreateDiv.style.display="block")}function generateSearchResultSubject(e,t){return"<li onclick=\"addToSubjectsToAdd('".concat(t,"', this.querySelector('input[name=\\'id\\']').checked);\" class=\"searchResult\">\n            <label for=\"checkbox-").concat(t,'">\n              <input style="display: none;" type="checkbox" value="').concat(t,'" name="id" id="checkbox-').concat(t,'" ').concat(subjects[t]||subjectsToAdd[t]?"checked":""," ").concat(subjects[t]?"disabled":"",'>\n              <div class="searchResultCheck" for="checkbox-').concat(t,'"></div>\n            </label>\n            <label class="searchResultTitle" for="checkbox-').concat(t,'">\n              <span class="searchResultRow1">').concat(e.shortName.value," - ").concat(e.fullName.value,'</span><br>\n              <span class="searchResultRow2">').concat(e.faculty.value," ").concat(e.uni.value," - ").concat(e.course.value,"</span>\n            </label>\n            ").concat(subjects[t]?"\x3c!-- ":"","<div class=\"searchResultAction\" onclick=\"this.parentElement.querySelector('input[name=\\'id\\']').checked = true; showViewSubject('").concat(t,'\');"><img src="media/edit.svg"></div>').concat(subjects[t]?" --\x3e ":"","\n          </li>")}function install(){void 0!==deferredPrompt&&(deferredPrompt.prompt(),deferredPrompt.userChoice.then(function(e){e.outcome,deferredPrompt=null}))}provider.setCustomParameters({prompt:"select_account"}),provider.addScope("https://www.googleapis.com/auth/userinfo.profile"),firebase.auth().useDeviceLanguage(),firebase.auth().getRedirectResult().catch(function(e){console.error(e)}),firebase.auth().onAuthStateChanged(function(e){var t=document.getElementById("loginButton");e?(displayName=e.displayName,photoURL=e.photoURL,isAnonymous=e.isAnonymous,uid=e.uid,console.info("Signed in as ".concat(displayName," whith ID: ").concat(uid)),t.textContent="Cerrar sesión",t.classList.add("btn-red"),t.classList.remove("btn-green"),t.onclick=function(){logoutGoogle(),window.history.back()},showLoader("Buscando cambios","dashboard"),userDB=db.collection("users").doc(uid),getAndDisplayUserSubjects()):(hideLoader("dashboard"),displayName="Anónimo",photoURL="media/profile-pic.jpg",isAnonymous=!0,uid=0,userDB=null,console.info("Signed out"),t.textContent="Iniciar sesión",t.classList.remove("btn-red"),t.classList.add("btn-green"),t.onclick=function(){loginGoogle(),window.history.back()},showToast("Guarda tus notas en la nube","Iniciar sesión","loginGoogle();")),document.getElementById("user-container").children[1].children[0].src=photoURL,document.getElementById("profile-topbar").src=isAnonymous?"media/user-circle.svg":photoURL,document.getElementById("user-container").children[1].children[1].textContent=displayName}),window.addEventListener("beforeinstallprompt",function(e){return console.log("App can be installed"),deferredPrompt=e,setTimeout(function(){showToast("Usa GradeCalc offline","Instalar","install();")},1e4),!1});